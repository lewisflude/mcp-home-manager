name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  check-formatting:
    name: Check Nix Formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      - name: Check formatting
        run: |
          nix fmt -- --check .

  lint:
    name: Lint Nix Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      - name: Run statix
        run: |
          nix develop --command statix check .
      
      - name: Run deadnix
        run: |
          nix develop --command deadnix --fail .

  flake-check:
    name: Nix Flake Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      - name: Flake check
        run: |
          nix flake check --all-systems

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      - name: Run test suite
        run: |
          chmod +x tests/run-tests.sh
          nix develop --command ./tests/run-tests.sh

  build-examples:
    name: Build Examples
    runs-on: ubuntu-latest
    strategy:
      matrix:
        example:
          - basic
          - advanced
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      - name: Evaluate example
        run: |
          nix eval --impure --expr '
            let
              nixpkgs = builtins.getFlake "github:NixOS/nixpkgs/nixos-unstable";
              system = builtins.currentSystem;
              pkgs = nixpkgs.legacyPackages.${system};
              lib = pkgs.lib;
              exampleConfig = import ./examples/${{ matrix.example }}.nix;
              
              # Mock home-manager module that provides necessary options
              mockHomeManager = {
                options = {
                  home.homeDirectory = lib.mkOption {
                    type = lib.types.str;
                    default = "/home/testuser";
                  };
                  home.packages = lib.mkOption {
                    type = lib.types.listOf lib.types.package;
                    default = [];
                  };
                  home.file = lib.mkOption {
                    type = lib.types.attrsOf lib.types.anything;
                    default = {};
                  };
                  home.activation = lib.mkOption {
                    type = lib.types.attrsOf lib.types.anything;
                    default = {};
                  };
                };
              };
              
              evaluated = lib.evalModules {
                modules = [
                  mockHomeManager
                  ./modules/default.nix
                  exampleConfig
                  { _module.args = { inherit pkgs; }; }
                ];
              };
            in
              evaluated.config.services.mcp.enable
          '
